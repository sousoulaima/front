<div class="gestion-reglements-container">
  <div class="gestion-reglements">
    <!-- Modal for Adding/Editing a Payment -->
    <div class="modal" *ngIf="showModal" @modalAnimation>
      <div class="modal-content">
        <h2 class="modal-title">{{ isEditing ? '√âditer le r√®glement' : 'Ajouter un r√®glement' }}</h2>
        <form (ngSubmit)="savePayment()" #paymentForm="ngForm">
          <div class="form-group">
            <label>Code</label>
            <input
              type="text"
              [(ngModel)]="currentPayment.codeReg"
              name="codeReg"
              required
              readonly
              #codeReg="ngModel"
              class="form-input"
            />
            <span class="error" *ngIf="codeReg.invalid && codeReg.touched">Le code est requis</span>
          </div>
          <div class="form-group">
            <label>Date</label>
            <input
              type="date"
              [(ngModel)]="currentPayment.dateReg"
              name="dateReg"
              required
              #dateReg="ngModel"
              class="form-input"
            />
            <span class="error" *ngIf="dateReg.invalid && dateReg.touched">La date est requise</span>
          </div>
          <div class="form-group">
            <label>Mode de r√®glement</label>
            <select
              [(ngModel)]="currentPayment.modaliteRegCodeMod"
              name="modaliteRegCodeMod"
              required
              #modaliteRegCodeMod="ngModel"
              class="form-input"
            >
              <option *ngFor="let modalite of modaliteRegs" [value]="modalite.codeMod">
                {{ modalite.designationMod }}
              </option>
            </select>
            <span class="error" *ngIf="modaliteRegCodeMod.invalid && modaliteRegCodeMod.touched">Le mode est requis</span>
          </div>
          <div class="form-group">
            <label>Montant (DT)</label>
            <input
              type="number"
              [(ngModel)]="currentPayment.mtrReg"
              name="mtrReg"
              required
              min="0"
              step="0.01"
              #mtrReg="ngModel"
              class="form-input"
            />
            <span class="error" *ngIf="mtrReg.invalid && mtrReg.touched">Un montant valide est requis</span>
          </div>
          <div class="form-group">
            <label>Num√©ro de Ch√®que (optionnel)</label>
            <input
              type="text"
              [(ngModel)]="currentPayment.numChq"
              name="numChq"
              class="form-input"
            />
          </div>
          <div class="form-group">
            <label>Num√©ro de Traite (optionnel)</label>
            <input
              type="text"
              [(ngModel)]="currentPayment.numTraite"
              name="numTraite"
              class="form-input"
            />
          </div>
          <div class="form-group">
            <label>Abonnement</label>
            <select
              [(ngModel)]="currentPayment.abonnementCodeAbo"
              name="abonnementCodeAbo"
              required
              #abonnementCodeAbo="ngModel"
              class="form-input"
            >
              <option *ngFor="let abo of abonnements" [value]="abo.codeAbo">
                {{ abo.codeAbo }}
              </option>
            </select>
            <span class="error" *ngIf="abonnementCodeAbo.invalid && abonnementCodeAbo.touched">L'abonnement est requis</span>
          </div>
          <div class="form-group">
            <label>Commentaire</label>
            <textarea
              [(ngModel)]="currentPayment.commentaire"
              name="commentaire"
              class="form-input"
              rows="3"
            ></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="cancel-btn" (click)="closeModal()">Annuler</button>
            <button type="submit" class="save-btn" [disabled]="!paymentForm.valid">Sauvegarder</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal for Viewing a Payment -->
    <div class="modal" *ngIf="showViewModal" @modalAnimation>
      <div class="modal-content">
        <h2 class="modal-title">D√©tails du r√®glement</h2>
        <div class="user-details">
          <p><strong>Code :</strong> {{ viewedPayment?.codeReg }}</p>
          <p><strong>Date :</strong> {{ viewedPayment?.dateReg }}</p>
          <p><strong>Mode :</strong> {{ getModaliteRegDesignation(viewedPayment?.modaliteRegCodeMod!) }}</p>
          <p><strong>Montant :</strong> {{ viewedPayment?.mtrReg }} DT</p>
          <p><strong>Num√©ro de Ch√®que :</strong> {{ viewedPayment?.numChq || 'Aucun' }}</p>
          <p><strong>Num√©ro de Traite :</strong> {{ viewedPayment?.numTraite || 'Aucun' }}</p>
          <p><strong>Abonnement :</strong> {{ viewedPayment?.abonnementCodeAbo }}</p>
          <p><strong>Commentaire :</strong> {{ viewedPayment?.commentaire || 'Aucun' }}</p>
        </div>
        <div class="modal-actions">
          <button class="close-btn" (click)="closeViewModal()">Fermer</button>
        </div>
      </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div class="modal" *ngIf="showDeleteConfirm" @modalAnimation>
      <div class="modal-content">
        <h2 class="modal-title">Confirmer la suppression</h2>
        <p class="modal-text">√ätes-vous s√ªr de vouloir supprimer le r√®glement {{ paymentToDelete?.codeReg }} ?</p>
        <div class="modal-actions">
          <button class="cancel-btn" (click)="cancelDelete()">Annuler</button>
          <button class="delete-btn" (click)="deletePayment()">Supprimer</button>
        </div>
      </div>
    </div>

    <!-- Header Section -->
    <div class="header">
      <div class="header-title">
        <h1 class="text-blue-800 animate-fade-in">Module de R√®glement</h1>
        <p class="text-gray-600 animate-fade-in">Gestion des r√®glements et transactions ({{ filteredPayments.length }} r√®glements)</p>
      </div>
      <button class="add-btn bg-blue-600 hover:bg-blue-700 text-white" (click)="openAddPaymentModal()">+ Ajouter un r√®glement</button>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter">
      <div class="search">
        <input
          type="text"
          placeholder="Rechercher un r√®glement..."
          [(ngModel)]="searchQuery"
          (input)="filterPayments()"
          class="search-input"
        />
        <span class="search-icon">üîç</span>
      </div>
      <div class="filter-container">
        <button class="filter-btn" (click)="toggleFilter()">Filtrer ‚ñº</button>
        <div class="filter-dropdown" *ngIf="showFilter">
          <label class="filter-label">
            Mode :
            <select [(ngModel)]="filterMode" (change)="filterPayments()" class="filter-select">
              <option value="">Tous</option>
              <option *ngFor="let modalite of modaliteRegs" [value]="modalite.codeMod">
                {{ modalite.designationMod }}
              </option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- Payments Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>CODE</th>
            <th>DATE</th>
            <th>MODE</th>
            <th>MONTANT</th>
            <th>NUM. CH√àQUE</th>
            <th>NUM. TRAITE</th>
            <th>ABONNEMENT</th>
            <th>COMMENTAIRE</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let payment of filteredPayments; let i = index"
            class="animate-slide-in-right"
            [ngClass]="'animation-delay-' + (i * 100)"
          >
            <td>{{ payment.codeReg }}</td>
            <td>{{ payment.dateReg }}</td>
            <td>{{ getModaliteRegDesignation(payment.modaliteRegCodeMod) }}</td>
            <td>{{ payment.mtrReg }} DT</td>
            <td>{{ payment.numChq || 'Aucun' }}</td>
            <td>{{ payment.numTraite || 'Aucun' }}</td>
            <td>{{ payment.abonnementCodeAbo }}</td>
            <td>{{ payment.commentaire || 'Aucun' }}</td>
            <td class="actions">
              <button class="action-btn view" (click)="viewPayment(payment)" title="Voir">üëÅÔ∏è</button>
              <button class="action-btn edit" (click)="openEditPaymentModal(payment)" title="√âditer">‚úèÔ∏è</button>
              <button class="action-btn delete" (click)="confirmDeletePayment(payment)" title="Supprimer">üóëÔ∏è</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>